  @if (weatherApi.loading()) {
    <div class="loading-overlay">
      <div class="spinner"></div>
      <p>Laden…</p>
    </div>
  }

<div class="matrix" [class.loading-active]="weatherApi.loading()">
  <div class="label">Date: {{ astroDate() }}</div>
  <br>
  <div class="matrix-controls">
    <button
      [class.active]="mode() === '24h'"
      (click)="mode.set('24h')">
      24h
    </button>
    <button
      [class.active]="mode() === '24h/48h'"
      (click)="mode.set('24h/48h')">
      24h/48h
    </button>
      <button
      [class.active]="mode() === '48h/72h'"
      (click)="mode.set('48h/72h')">
      48h/72h
    </button>
    <!-- <button
      [class.active]="mode() === 'all'"
      (click)="mode.set('all')">
      All
    </button> -->
  </div>
  <br><br>

  @if (hoverCard()) {
  <div class="matrix-tooltip" *ngIf="hoverCard()" [style.top.px]="tooltipY" [style.left.px]="tooltipX">
    <strong>{{ hoverCard().time | date:'HH:mm' }}</strong>
    <div>Cloud cover: {{ hoverCard().cloudcover }}/9</div>
    <div>Seeing: {{ hoverCard().seeing }}/8</div>
    <div>Transparency: {{ hoverCard().transparency }}/8</div>
    <div>Temp: {{ hoverCard().temperature }} °C</div>
    <div>Wind: {{ hoverCard().windSpeed }} m/s {{ hoverCard().windDir }}</div>
  </div>
}

  <!-- header row -->
  <div class="row header">
    <div class="label"></div>
    @for (c of cardsToShow(); track c.time) {
      <div class="cell time" (touchstart)="onMobileHover(c, $event)" (mouseenter)="onHover(c, $event)"
     (mouseleave)="onHover(null, null)">{{ c.time | date:'HH:mm' }}h</div>
    }
  </div>
  <div class="row header">
    <div class="label"></div>
    @for (c of cardsToShow(); track c.timepoint) {
      <div class="cell time" (touchstart)="onMobileHover(c, $event)" (mouseenter)="onHover(c, $event)"
     (mouseleave)="onHover(null, null)">+{{ c.timepoint }}h</div>
    }
  </div>

  <!-- cloud cover -->
  <div class="row">
    <div class="label">Cloud</div>
    @for (c of cardsToShow(); track c.timepoint) {
      <div class="cell" (touchstart)="onMobileHover(c, $event)" (mouseenter)="onHover(c, $event)"
     (mouseleave)="onHover(null, null)">
        <span
          class="dot cloud"
          [class.c1]="c.cloudcover == 1"
          [class.c2]="c.cloudcover == 2"
          [class.c3]="c.cloudcover == 3"
          [class.c4]="c.cloudcover == 4"
          [class.c5]="c.cloudcover == 5"
          [class.c6]="c.cloudcover == 6"
          [class.c7]="c.cloudcover == 7"
          [class.c8]="c.cloudcover == 8"
          [class.c9]="c.cloudcover == 9"
        ></span>
      </div>
    }
  </div>

  <!-- seeing -->
  <div class="row">
    <div class="label">Seeing</div>
    @for (c of cardsToShow(); track c.timepoint) {
      <div class="cell" (touchstart)="onMobileHover(c, $event)" (mouseenter)="onHover(c, $event)"
     (mouseleave)="onHover(null, null)">
        <span class="dot seeing s{{ c.seeing }}"></span>
      </div>
    }
  </div>

  <!-- transparency -->
  <div class="row">
    <div class="label">Transparency</div>
    @for (c of cardsToShow(); track c.timepoint) {
      <div class="cell" (touchstart)="onMobileHover(c, $event)" (mouseenter)="onHover(c, $event)"
     (mouseleave)="onHover(null, null)">
        <span
          class="bar trans"
          [class.t2]="c.transparency <= 2"
          [class.t6]="c.transparency > 2 && c.transparency <= 6"
          [class.t9]="c.transparency > 6">
        </span>      
      </div>
    }
  </div>

  <!-- temperature -->
  <div class="row">
    <div class="label">Temp</div>
    @for (c of cardsToShow(); track c.timepoint) {
      <div class="cell temp" (touchstart)="onMobileHover(c, $event)" (mouseenter)="onHover(c, $event)"
     (mouseleave)="onHover(null, null)">{{ c.temperature }}°</div>
    }
  </div>

  <!-- Twilight -->
  <div class="row">
    <div class="label">Twilight</div>
    @for (c of cardsToShow(); track c.timepoint) {
      <div
        class="cell astro-hack" (touchstart)="onMobileHover(c, $event)" (mouseenter)="onHover(c, $event)"
     (mouseleave)="onHover(null, null)"
        [class.astro-night]="isAstroNight(c.time) === 'full'"
        [class.astro-night-partial]="isAstroNight(c.time) === 'partial'">
        &nbsp;
      </div>
    }
  </div>

  <!-- Moon -->
  <div class="row">
    <div class="label">Moon</div>
    @for (c of cardsToShow(); track c.timepoint) {
      <div
        class="cell" (touchstart)="onMobileHover(c, $event)" (mouseenter)="onHover(c, $event)"
     (mouseleave)="onHover(null, null)"
        [class.moon-bar]="moonUpAt(c.time) === 'full'"
        [class.moon-bar-partial]="moonUpAt(c.time) === 'partial'">
        &nbsp;
      </div>
    }
  </div>
</div>

<div class="matrix-legend">
  <!-- Clouds -->
  <h3>Clouds</h3>
  <div class="legend-item legend-trans">
    <span class="dot cloud c1"></span><span>No clouds</span>
    <span class="dot cloud c9"></span><span>Many clouds</span>
  </div>

  <!-- Seeing -->
  <h3>Seeing</h3>
  <div class="legend-item legend-trans">
    <span class="dot seeing s1"></span><span>Very poor</span>
    <span class="dot seeing s9"></span><span>Excellent</span>
  </div>

  <!-- Transparency -->
  <h3>Transparency</h3>
  <div class="legend-item legend-trans">
    <span class="bar trans t2"></span>
    <span>Low transparency</span>

    <span class="bar trans t6"></span>
    <span>Medium</span>

    <span class="bar trans t9"></span>
    <span>High (best)</span>
  </div>

  <!-- Twilight / Astro Night -->
  <div class="legend-item">
    <span class="cell astro-night">&nbsp;</span>
    <span>Astronomical night</span>
  </div>

  <!-- Moon -->
  <div class="legend-item">
    <span class="cell moon-bar">&nbsp;</span>
    <span>Moon above horizon</span>
  </div>
</div>


<div class="astro-times">
  <div class="astro-grid">
    <div>Sunrise<span>{{ sunTimes().sunrise | date:'HH:mm' }}</span></div>
    <div>Sunset<span>{{ sunTimes().sunset | date:'HH:mm' }}</span></div>

    <div>Civil dawn<span>{{ sunTimes().dawn | date:'HH:mm' }}</span></div>
    <div>Civil dusk<span>{{ sunTimes().dusk | date:'HH:mm' }}</span></div>

    <div>Nautical dawn<span>{{ sunTimes().nauticalDawn | date:'HH:mm' }}</span></div>
    <div>Nautical dusk<span>{{ sunTimes().nauticalDusk | date:'HH:mm' }}</span></div>

    <div>Astronomical dawn<span>{{ sunTimes().nightEnd | date:'HH:mm' }}</span></div>
    <div>Astronomical dusk<span>{{ sunTimes().night | date:'HH:mm' }}</span></div>

    <div>Moonrise<span>{{ moonTimes().rise ? (moonTimes().rise | date:'HH:mm') : '—' }}</span></div>
    <div>Moonset<span>{{ moonTimes().set ? (moonTimes().set | date:'HH:mm') : '—' }}</span></div>

    <div class="full">Moon phase<span>{{ moonPhaseLabel() }}</span></div>
  </div>
</div>
<br><br>